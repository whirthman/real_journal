<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pro Trading Journal v2</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#0f172a;
  --panel:#1e293b;
  --card:#0f172a;
  --muted:#94a3b8;
  --line:#334155;
  --accent:#3b82f6;
  --win: #059669;
  --loss: #dc2626;
  --text:#f8fafc;
}

body{
  margin:0;
  font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  background:var(--bg);
  color:var(--text);
  padding:10px;
  line-height: 1.5;
}

h1{
  text-align:center;
  font-weight: 700;
  letter-spacing: -1px;
  margin: 20px 0;
  color: var(--text);
}

/* BUTTONS */
button{
  background:var(--accent);
  border:none;
  color:white;
  padding:10px 18px;
  border-radius:8px;
  cursor:pointer;
  font-weight: 600;
  transition: all 0.2s;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}
button:hover{background:#2563eb; transform: translateY(-1px);}
.btn-outline{ background: transparent; border: 1px solid var(--line); }
.btn-danger{ background: #7f1d1d; }
.btn-danger:hover{ background: #b91c1c; }
.btn-success{ background: var(--win); }

/* MODAL STYLES */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.8);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:1000;
  backdrop-filter: blur(4px);
}

.modal-content{
  background:var(--panel);
  width:95%;
  max-width:800px;
  max-height:90vh;
  overflow:auto;
  border-radius:16px;
  padding:30px;
  box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
}

.close{
  float:right;
  cursor:pointer;
  color:var(--muted);
  font-size: 24px;
}

/* FORM STYLES */
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

label{
  font-size:12px;
  font-weight: 600;
  margin-top:10px;
  display:block;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

input,select,textarea{
  width:100%;
  padding:12px;
  background:var(--card);
  border: 1px solid var(--line);
  border-radius:8px;
  color:white;
  box-sizing: border-box;
  margin-top: 5px;
}

input:focus{ outline: 2px solid var(--accent); border-color: transparent; }

textarea{resize:vertical;}

fieldset{
  border:1px solid var(--line);
  margin-top:20px;
  padding:15px;
  border-radius: 8px;
  grid-column: 1 / -1;
}

legend{
  font-size:12px;
  padding:0 10px;
  font-weight: bold;
}

.checkbox-group{
  display:grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap:8px;
}

.checkbox-group label {
    display: flex;
    align-items: center;
    gap: 5px;
    text-transform: none;
    color: var(--text);
    cursor: pointer;
}

/* DASHBOARD / FILTER BAR */
.control-panel {
    background: var(--panel);
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 20px;
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    align-items: flex-end;
    border: 1px solid var(--line);
}

.filter-group { flex: 1; min-width: 180px; }

/* TABLE STYLES */
.table-container{
  overflow-x:auto;
  background: var(--panel);
  padding: 5px;
  border-radius: 12px;
  border: 1px solid var(--line);
}

table{
  border-collapse:collapse;
  min-width:1800px;
  width:100%;
}

th{
  background:var(--panel);
  padding:15px 10px;
  text-align: left;
  font-size: 11px;
  text-transform: uppercase;
  color: var(--muted);
  border-bottom: 2px solid var(--line);
  cursor: pointer;
}
th:hover { color: var(--accent); }

td{
  padding:12px 10px;
  font-size:13px;
  border-bottom: 1px solid var(--line);
}

.row-win { background-color: rgba(5, 150, 105, 0.2) !important; border-left: 4px solid var(--win); }
.row-loss { background-color: rgba(220, 38, 38, 0.2) !important; border-left: 4px solid var(--loss); }

.actions-top{
  display:flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  flex-wrap: wrap;
  gap: 10px;
}

.data-btns { display: flex; gap: 8px; }

/* MOBILE RESPONSIVENESS */
@media (max-width: 768px) {
    .form-grid { grid-template-columns: 1fr; }
    .control-panel { flex-direction: column; align-items: stretch; }
}
</style>
</head>

<body>

<h1>Trading Journal <span style="color:var(--accent)">v1.2</span></h1>

<div class="actions-top">
    <button onclick="openModal('formModal')" class="btn-success">Log New Trade +</button>
    <div class="data-btns">
        <button class="btn-outline" onclick="exportCSV()">Export CSV</button>
        <button class="btn-outline" onclick="document.getElementById('csvImport').click()">Import CSV</button>
        <input type="file" id="csvImport" style="display:none" accept=".csv" onchange="importCSV(event)">
        <button class="btn-danger" onclick="clearData()">Clear All</button>
    </div>
</div>

<div class="control-panel">
    <div class="filter-group">
        <label>Search Instrument</label>
        <input type="text" id="searchInput" placeholder="Search..." onkeyup="render()">
    </div>
    <div class="filter-group">
        <label>Result</label>
        <select id="filterResult" onchange="render()">
            <option value="all">All</option>
            <option value="Win">Win</option>
            <option value="Loss">Loss</option>
        </select>
    </div>
    <div class="filter-group">
        <label>Start Date</label>
        <input type="date" id="filterStart" onchange="render()">
    </div>
    <div class="filter-group">
        <label>End Date</label>
        <input type="date" id="filterEnd" onchange="render()">
    </div>
</div>

<div class="table-container">
    <table id="tradeTable">
    <thead>
    <tr>
    <th onclick="setSort('displayId')">ID â†•</th>
    <th onclick="setSort('date')">Date â†•</th>
    <th onclick="setSort('broker')">Broker â†•</th>
    <th onclick="setSort('instrument')">Instrument â†•</th>
    <th>Direction</th>
    <th>Entry</th>
    <th>Exit</th>
    <th onclick="setSort('result')">Result â†•</th>
    <th onclick="setSort('pnl')">PnL â†•</th>
    <th>Duration</th>
    <th>Action</th>
    </tr>
    </thead>
    <tbody></tbody>
    </table>
</div>

<div class="modal" id="detailsModal">
<div class="modal-content">
<span class="close" onclick="closeModal('detailsModal')">âœ•</span>
<h2 style="margin-top:0">Trade Details</h2>
<div id="detailsContent" style="display:grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px;">
</div>

<fieldset style="margin-top: 20px;">
<legend>Analysis Details</legend>
<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
  <div><strong>Market Direction:</strong> <span id="detailMarketDirection">-</span></div>
  <div><strong>Market Condition:</strong> <span id="detailMarketCondition">-</span></div>
  <div><strong>Execution TF:</strong> <span id="detailExecutionTF">-</span></div>
  <div><strong>Timeframes:</strong> <span id="detailTf">-</span></div>
  <div><strong>Confluence:</strong> <span id="detailConf">-</span></div>
  <div><strong>Indicators:</strong> <span id="detailInd">-</span></div>
  <div><strong>Psychology:</strong> <span id="detailPsy">-</span></div>
  <div><strong>Strategy:</strong> <span id="detailStrategy">-</span></div>
</div>
</fieldset>

<div style="margin-top: 20px;">
<strong>Trade Notes:</strong>
<div style="background: var(--card); padding: 12px; border-radius: 8px; border: 1px solid var(--line); margin-top: 8px;">
  <span id="detailNotes" style="white-space: pre-wrap;">-</span>
</div>
</div>

<fieldset style="margin-top: 20px;">
<legend>Chart Screenshots</legend>
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 15px;">
  <div>
    <p style="margin: 0 0 10px 0; font-weight: 600;">Setup Chart</p>
    <img id="detailSetupImg" src="" alt="Setup" style="width: 100%; border-radius: 8px; border: 1px solid var(--line); display: none; cursor: pointer;" onclick="openImageModal(this.src)">
    <div id="detailSetupPlaceholder" style="width: 100%; aspect-ratio: 16/9; background: var(--card); border: 2px dashed var(--line); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--muted);">No image</div>
  </div>
  <div>
    <p style="margin: 0 0 10px 0; font-weight: 600;">Entry Chart</p>
    <img id="detailEntryImg" src="" alt="Entry" style="width: 100%; border-radius: 8px; border: 1px solid var(--line); display: none; cursor: pointer;" onclick="openImageModal(this.src)">
    <div id="detailEntryPlaceholder" style="width: 100%; aspect-ratio: 16/9; background: var(--card); border: 2px dashed var(--line); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--muted);">No image</div>
  </div>
  <div>
    <p style="margin: 0 0 10px 0; font-weight: 600;">Exit Chart</p>
    <img id="detailExitImg" src="" alt="Exit" style="width: 100%; border-radius: 8px; border: 1px solid var(--line); display: none; cursor: pointer;" onclick="openImageModal(this.src)">
    <div id="detailExitPlaceholder" style="width: 100%; aspect-ratio: 16/9; background: var(--card); border: 2px dashed var(--line); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: var(--muted);">No image</div>
  </div>
</div>
</fieldset>

<div style="display: flex; gap: 10px; margin-top: 20px;">
  <button class="btn-outline" onclick="editTradeFromDetails()" style="flex: 1;">Edit Trade</button>
  <button class="btn-danger" onclick="deleteTradeFromDetails()" style="flex: 1;">Delete Trade</button>
</div>
</div>
</div>

<div class="modal" id="imageModal">
<div style="position: relative; width: 95%; max-width: 90vh; max-height: 90vh; display: flex; align-items: center; justify-content: center;">
<span class="close" onclick="closeModal('imageModal')" style="position: absolute; top: -40px; right: 0; font-size: 32px;">âœ•</span>
<img id="fullImage" src="" alt="Full View" style="max-width: 100%; max-height: 100%; border-radius: 8px;">
</div>
</div>

<div class="modal" id="formModal">
<div class="modal-content">
<span class="close" onclick="closeModal('formModal')">âœ•</span>
<h2 style="margin-top:0">Log New Trade</h2>

<form id="tradeForm">
<!-- added names and ids for all inputs and a hidden editId -->
<input type="hidden" id="editId" name="editId" value="">
<div class="form-grid">
    <div>
        <label>Broker</label>
        <input name="broker" id="broker" required placeholder="e.g. IC Markets">
    </div>
    <div>
        <label>Account</label>
        <input name="account" id="account" required placeholder="e.g. Live Personal">
    </div>
    <div>
        <label>Trade Type</label>
        <select id="tradeType" name="tradeType" required>
          <option value="">Select Type</option>
          <option>Scalping</option>
          <option>Day Trading</option>
          <option>Swing Trading</option>
          <option>Position Trading</option>
        </select>
    </div>
    <div>
        <label>Market</label>
        <select id="market" name="market" required>
          <option value="">Select Market</option>
          <option>Forex</option>
          <option>Crypto</option>
          <option>Indices</option>
          <option>Metals</option>

        </select>
    </div>
    <div>
        <label>Instrument</label>
        <select id="instrument" name="instrument" required></select>
    </div>
    <div>
        <label>Direction</label>
        <select id="direction" name="direction" required>
          <option>Buy / Long</option>
          <option>Sell / Short</option>
        </select>
    </div>
    <div>
        <label>Entry Price</label>
        <input type="number" step="any" id="entryPrice" name="entryPrice" required>
    </div>
    <div>
        <label>Exit Price</label>
        <input type="number" step="any" id="exitPrice" name="exitPrice" required>
    </div>
    <div>
        <label>Stop Loss</label>
        <input type="number" step="any" id="sl" name="sl">
    </div>
    <div>
        <label>Result</label>
        <select id="result" name="result" required>
            <option value="Win">Win</option>
            <option value="Loss">Loss</option>
        </select>
    </div>
    <div>
        <label>Lot Size</label>
        <input type="number" step="any" id="lot" name="lot">
    </div>
    <div>
        <label>Risk ($)</label>
        <input type="number" step="any" id="risk" name="risk">
    </div>
    <div>
        <label>Net PnL ($)</label>
        <input type="number" step="any" id="pnl" name="pnl">
    </div>
     <div>
        <label>Equity Before ($)</label>
        <input type="number" step="any" id="equityBefore" name="equityBefore">
    </div>
    <div>
        <label>Equity After ($)</label>
        <input type="number" step="any" id="equityAfter" name="equityAfter">
    </div>
    <div>
        <label>Entry Date & Time</label>
        <input type="datetime-local" required id="entryDateTime" name="entryDateTime">
    </div>
    <div>
        <label>Exit Date & Time</label>
        <input type="datetime-local" required id="exitDateTime" name="exitDateTime">
    </div>
</div>

<fieldset>
<legend>Analysis Details</legend>
<div>
        <label>Market Direction</label>
        <select id="marketDirection" name="marketDirection" required>
          <option>Bullish</option>
          <option>Bearish</option>
          <option>Range Bound (Sideways)</option>

        </select>
 </div>
 <div>
        <label>Market Condition</label>
        <select id="marketCondition" name="marketCondition" required>
          <option>Trending</option>
          <option>Range Bound (Consolidation)</option>
          <option>Volatile</option>
        </select>
 </div>  
 <div>
       <label>Execution Timeframe</label>
       <select id="executionTF" name="executionTF">
         <option value="">Select Execution TF</option>
         <option>Monthly</option>
         <option>Weekly</option>
         <option>Daily</option>
         <option>H4</option>
         <option>H1</option>
         <option>M30</option>
         <option>M15</option>
         <option>M5</option>
         <option>M1</option>
       </select>
 </div>
<label>Timeframes</label>
<div class="checkbox-group" id="tf-group">
    <label><input type="checkbox" value="Monthly"> Monthly</label>
    <label><input type="checkbox" value="Weekly"> Weekly</label>
    <label><input type="checkbox" value="Daily"> Daily</label>
    <label><input type="checkbox" value="H4"> 4H</label>
    <label><input type="checkbox" value="H1"> 1H</label>
    <label><input type="checkbox" value="M30"> 30m</label>
    <label><input type="checkbox" value="M15"> 15m</label>
    <label><input type="checkbox" value="M5"> 5m</label>
    <label><input type="checkbox" value="M1"> 1m</label>
</div>
<label style="margin-top:15px">Confluence</label>
<div class="checkbox-group" id="conf-group">
    <label><input type="checkbox" value="FVG"> FVG</label>
    <label><input type="checkbox" value="OB"> OB</label>
    <label><input type="checkbox" value="BOS"> BOS</label>
    <label><input type="checkbox" value="Liquidity"> Liq Sweep</label>
    <label><input type="checkbox" value="Trendlines">Trendlines</label>
    <label><input type="checkbox" value="SR">Support Resistance Levels</label>
    <label><input type="checkbox" value="HTB">Higher Timeframe Bias</label>
    <label><input type="checkbox" value="Economic News">Fundamental Analysis (Economic News)</label>
</div>

<label style="margin-top:15px">Indicators Used</label>
<div class="checkbox-group" id="ind-group">
    <label><input type="checkbox" value="EMA 50"> EMA 50</label>
    <label><input type="checkbox" value="EMA 100"> EMA 100</label>
    <label><input type="checkbox" value="Volume"> Volume</label>
    <label><input type="checkbox" value="ZigZag"> ZigZag</label>
    <label><input type="checkbox" value="Stochastic"> Stochastic</label>
    <label><input type="checkbox" value="MACD"> MACD</label>
    <label><input type="checkbox" value="Fracture"> Fracture</label>
</div>

<label style="margin-top:15px">Trading Psychology</label>
<div class="checkbox-group" id="psy-group">
    <label><input type="checkbox" value="Calm"> Calm</label>
    <label><input type="checkbox" value="Confident"> Confident</label>
    <label><input type="checkbox" value="Fear"> Fear</label>
    <label><input type="checkbox" value="Discipline"> Discipline</label>
    <label><input type="checkbox" value="Greed"> Greed</label>
    <label><input type="checkbox" value="Patience"> Patience</label>
    <label><input type="checkbox" value="FOMO"> FOMO</label>
    <label><input type="checkbox" value="Overtrading"> Overtrading</label>
</div>
</fieldset>

<label>Strategy Used</label>
<input id="strategy" name="strategy" placeholder="Strategy used (e.g. Breakout, Mean Reversion)" style="width:100%; padding:12px; margin-top:5px; background:var(--card); border:1px solid var(--line); border-radius:8px; color:white;">

<label>Screenshot URLs (Setup / Entry / Exit)</label>
<div class="form-grid">
    <input id="setupUrl" name="setupUrl" placeholder="Setup URL">
    <input id="entryUrl" name="entryUrl" placeholder="Entry URL">
    <input id="exitUrl" name="exitUrl" placeholder="Exit URL">
</div>

<label>Trade Notes</label>
<textarea rows="3" id="notes" name="notes" placeholder="Describe your mindset and reason for trade..."></textarea>

<button type="submit" style="margin-top: 25px; width: 100%; padding: 15px;">ðŸ’¾ SAVE TRADE ENTRY</button>
</form>
</div>
</div>

<script>
const marketInstruments={
  Forex:["EURUSD","GBPUSD","USDJPY","AUDUSD","USDCAD","USDCHF","NZDUSD"],
  Crypto:["BTCUSD","ETHUSD","SOLUSD","BNBUSD"],
  Indices:["Volatility 50 Index","Volatility 75 Index","Volatility 100 Index"],
  Metals: ["XAUUSD","XAGUSD"]
};

const market=document.getElementById("market");
const instrument=document.getElementById("instrument");

market.onchange=()=> {
  const prev = instrument.value;
  instrument.innerHTML="";
  (marketInstruments[market.value]||[]).forEach(i=>{
    let o=document.createElement("option");
    o.textContent=i;
    o.value=i;
    instrument.appendChild(o);
  });
  // restore if present
  if(prev) instrument.value = prev;
};

let trades=JSON.parse(localStorage.getItem("journalTrades"))||[];
let sortKey = 'date';
let sortAsc = false;
const tbody=document.querySelector("#tradeTable tbody");

function openModal(id){
    document.getElementById(id).style.display="flex";
    const now = new Date().toISOString().slice(0, 16);
    // set defaults only if form is not in edit mode
    if(!document.getElementById('editId').value){
      document.getElementById('entryDateTime').value = now;
      document.getElementById('exitDateTime').value = now;
    }
}
function closeModal(id){
  document.getElementById(id).style.display="none";
  // clear edit id when closing
  document.getElementById('editId').value = "";
  document.getElementById('tradeForm').reset();
}

function setSort(key) {
    if (sortKey === key) {
        sortAsc = !sortAsc;
    } else {
        sortKey = key;
        sortAsc = true;
    }
    render();
}

function formatDuration(entry, exit) {
  try {
    const e = new Date(entry);
    const x = new Date(exit);
    const diff = x - e;
    if(isNaN(diff)) return '-';
    const mins = Math.round(diff / 60000);
    if (mins < 60) return mins + ' min';
    if (mins < 1440) return (mins/60).toFixed(2) + ' hrs';
    return (mins/1440).toFixed(2) + ' days';
  } catch (err) {
    return '-';
  }
}

function render(){
  tbody.innerHTML="";
  const searchTerm = document.getElementById("searchInput").value.toLowerCase();
  const filterResult = document.getElementById("filterResult").value;
  const startDate = document.getElementById("filterStart").value;
  const endDate = document.getElementById("filterEnd").value;

  let filtered = trades.filter(t => {
      const matchSearch = (t.instrument||'').toLowerCase().includes(searchTerm) || (t.broker||'').toLowerCase().includes(searchTerm);
      const matchResult = filterResult === "all" || t.result === filterResult;
      const tradeDate = t.entryDateTime ? new Date(t.entryDateTime).setHours(0,0,0,0) : (t.date ? new Date(t.date).setHours(0,0,0,0) : null);
      const start = startDate ? new Date(startDate).setHours(0,0,0,0) : null;
      const end = endDate ? new Date(endDate).setHours(0,0,0,0) : null;
      return matchSearch && matchResult && (!start || tradeDate >= start) && (!end || tradeDate <= end);
  });

  filtered.sort((a,b)=> {
      let valA = a[sortKey] ?? '';
      let valB = b[sortKey] ?? '';
      
      // Handle numeric sorting
      if (!isNaN(valA) && !isNaN(valB) && valA !== "" && valB !== "") {
          valA = parseFloat(valA);
          valB = parseFloat(valB);
      }
      
      if (valA < valB) return sortAsc ? -1 : 1;
      if (valA > valB) return sortAsc ? 1 : -1;
      return 0;
  });

  filtered.forEach((t, idx)=>{
    let r=document.createElement("tr");
    r.className = t.result === "Win" ? "row-win" : "row-loss";
    const entryDisplay = t.entryDateTime ? new Date(t.entryDateTime).toLocaleString() : (t.date ? new Date(t.date).toLocaleString() : '-');
    r.innerHTML=
      `<td>${t.displayId}</td>
       <td>${entryDisplay}</td>
       <td>${t.broker||'-'}</td>
       <td>${t.instrument||'-'}</td>
       <td>${t.direction||'-'}</td>
       <td>${t.entryPrice||'-'}</td>
       <td>${t.exitPrice||'-'}</td>
       <td>${t.result||'-'}</td>
       <td>${t.pnl||'-'}</td>
       <td>${formatDuration(t.entryDateTime, t.exitDateTime)}</td>
       <td>
          <button class="btn-outline" style="padding:4px 8px; margin-right:6px" onclick="viewTradeDetails('${t.id}')">Details</button>
          <button class="btn-danger" style="padding:4px 8px" onclick="del('${t.id}')">Delete</button>
       </td>`;
    tbody.appendChild(r);
  });
}

function del(id){
  if(confirm("Delete this trade?")){
    trades = trades.filter(t => t.id !== id);
    // recompute displayId
    trades.forEach((tr,i)=> tr.displayId = i+1);
    localStorage.setItem("journalTrades",JSON.stringify(trades));
    render();
  }
}

function clearData(){
    if(confirm("WARNING: This will delete ALL trades permanently. Proceed?")){
        trades = [];
        localStorage.setItem("journalTrades", JSON.stringify(trades));
        render();
    }
}

document.getElementById("tradeForm").onsubmit=e=>{
  e.preventDefault();
  const f = e.target;
  const chk=id=>[...document.querySelectorAll(`#${id} input:checked`)].map(x=>x.value).join(", ");

  const record = {
    // use editId if present
    id: document.getElementById('editId').value || Date.now().toString(),
    date: document.getElementById('entryDateTime').value,
    entryDateTime: document.getElementById('entryDateTime').value,
    exitDateTime: document.getElementById('exitDateTime').value,
    broker: document.getElementById('broker').value,
    account: document.getElementById('account').value,
    market: document.getElementById('market').value,
    instrument: document.getElementById('instrument').value,
    tradeType: document.getElementById('tradeType').value,
    direction: document.getElementById('direction').value,
    entryPrice: document.getElementById('entryPrice').value,
    exitPrice: document.getElementById('exitPrice').value,
    sl: document.getElementById('sl').value,
    result: document.getElementById('result').value,
    lot: document.getElementById('lot').value,
    risk: document.getElementById('risk').value,
    pnl: document.getElementById('pnl').value,
    equityBefore: document.getElementById('equityBefore').value,
    equityAfter: document.getElementById('equityAfter').value,
    marketDirection: document.getElementById('marketDirection').value,
    marketCondition: document.getElementById('marketCondition').value,
    executionTF: document.getElementById('executionTF').value,
    tf: chk("tf-group"),
    conf: chk("conf-group"),
    ind: chk("ind-group"),
    psy: chk("psy-group"),
    setupUrl: document.getElementById('setupUrl').value,
    entryUrl: document.getElementById('entryUrl').value,
    exitUrl: document.getElementById('exitUrl').value,
    strategy: document.getElementById('strategy').value,
    notes: document.getElementById('notes').value
  };

  const editingId = document.getElementById('editId').value;
  if(editingId){
    // update existing
    trades = trades.map(t => t.id === editingId ? { ...t, ...record } : t);
  } else {
    trades.push(record);
  }

  // recompute displayId
  trades.forEach((tr,i)=> tr.displayId = i+1);

  localStorage.setItem("journalTrades",JSON.stringify(trades));
  f.reset();
  document.getElementById('editId').value = "";
  closeModal('formModal');
  render();
};

function editTradeFromDetails(){
  const currentTradeId = document.getElementById('detailsModal').getAttribute('data-trade-id');
  closeModal('detailsModal');
  editTrade(currentTradeId);
}

function deleteTradeFromDetails(){
  const currentTradeId = document.getElementById('detailsModal').getAttribute('data-trade-id');
  closeModal('detailsModal');
  del(currentTradeId);
}

function viewTradeDetails(id){
  const t = trades.find(x=>x.id===id);
  if(!t) return alert("Trade not found");
  
  // Store trade id for edit/delete
  document.getElementById('detailsModal').setAttribute('data-trade-id', id);
  
  // Populate basic details
  const detailsContent = document.getElementById('detailsContent');
  detailsContent.innerHTML = `
    <div><strong>ID:</strong> ${t.displayId}</div>
    <div><strong>Entry Date:</strong> ${t.entryDateTime ? new Date(t.entryDateTime).toLocaleString() : '-'}</div>
    <div><strong>Exit Date:</strong> ${t.exitDateTime ? new Date(t.exitDateTime).toLocaleString() : '-'}</div>
    <div><strong>Duration:</strong> ${formatDuration(t.entryDateTime, t.exitDateTime)}</div>
    <div><strong>Broker:</strong> ${t.broker||'-'}</div>
    <div><strong>Account:</strong> ${t.account||'-'}</div>
    <div><strong>Market:</strong> ${t.market||'-'}</div>
    <div><strong>Instrument:</strong> ${t.instrument||'-'}</div>
    <div><strong>Direction:</strong> ${t.direction||'-'}</div>
    <div><strong>Trade Type:</strong> ${t.tradeType||'-'}</div>
    <div><strong>Entry Price:</strong> ${t.entryPrice||'-'}</div>
    <div><strong>Exit Price:</strong> ${t.exitPrice||'-'}</div>
    <div><strong>Stop Loss:</strong> ${t.sl||'-'}</div>
    <div><strong>Result:</strong> <span style="padding: 2px 8px; border-radius: 4px; background: ${t.result === 'Win' ? 'var(--win)' : 'var(--loss)'}; color: white;">${t.result||'-'}</span></div>
    <div><strong>Lot Size:</strong> ${t.lot||'-'}</div>
    <div><strong>Risk ($):</strong> ${t.risk||'-'}</div>
    <div><strong>PnL ($):</strong> <span style="color: ${t.pnl >= 0 ? 'var(--win)' : 'var(--loss)'}; font-weight: bold;">${t.pnl||'-'}</span></div>
    <div><strong>Equity Before:</strong> ${t.equityBefore||'-'}</div>
    <div><strong>Equity After:</strong> ${t.equityAfter||'-'}</div>
  `;
  
  // Populate analysis details
  document.getElementById('detailMarketDirection').textContent = t.marketDirection||'-';
  document.getElementById('detailMarketCondition').textContent = t.marketCondition||'-';
  document.getElementById('detailExecutionTF').textContent = t.executionTF||'-';
  document.getElementById('detailTf').textContent = t.tf||'-';
  document.getElementById('detailConf').textContent = t.conf||'-';
  document.getElementById('detailInd').textContent = t.ind||'-';
  document.getElementById('detailPsy').textContent = t.psy||'-';
  document.getElementById('detailStrategy').textContent = t.strategy||'-';
  document.getElementById('detailNotes').textContent = t.notes||'No notes added';
  
  // Handle images
  const setupImg = document.getElementById('detailSetupImg');
  const setupPlaceholder = document.getElementById('detailSetupPlaceholder');
  if(t.setupUrl){
    setupImg.src = t.setupUrl;
    setupImg.style.display = 'block';
    setupPlaceholder.style.display = 'none';
  } else {
    setupImg.style.display = 'none';
    setupPlaceholder.style.display = 'flex';
  }
  
  const entryImg = document.getElementById('detailEntryImg');
  const entryPlaceholder = document.getElementById('detailEntryPlaceholder');
  if(t.entryUrl){
    entryImg.src = t.entryUrl;
    entryImg.style.display = 'block';
    entryPlaceholder.style.display = 'none';
  } else {
    entryImg.style.display = 'none';
    entryPlaceholder.style.display = 'flex';
  }
  
  const exitImg = document.getElementById('detailExitImg');
  const exitPlaceholder = document.getElementById('detailExitPlaceholder');
  if(t.exitUrl){
    exitImg.src = t.exitUrl;
    exitImg.style.display = 'block';
    exitPlaceholder.style.display = 'none';
  } else {
    exitImg.style.display = 'none';
    exitPlaceholder.style.display = 'flex';
  }
  
  openModal('detailsModal');
}

function openImageModal(src){
  document.getElementById('fullImage').src = src;
  openModal('imageModal');
}

function editTrade(id){
  const t = trades.find(x=>x.id===id);
  if(!t) return alert("Trade not found");
  // populate form
  document.getElementById('editId').value = t.id;
  document.getElementById('broker').value = t.broker || '';
  document.getElementById('account').value = t.account || '';
  document.getElementById('tradeType').value = t.tradeType || '';
  document.getElementById('market').value = t.market || '';
  // trigger instrument repopulate
  market.onchange();
  setTimeout(()=> { document.getElementById('instrument').value = t.instrument || ''; }, 0);
  document.getElementById('direction').value = t.direction || '';
  document.getElementById('entryPrice').value = t.entryPrice || '';
  document.getElementById('exitPrice').value = t.exitPrice || '';
  document.getElementById('sl').value = t.sl || '';
  document.getElementById('result').value = t.result || '';
  document.getElementById('lot').value = t.lot || '';
  document.getElementById('risk').value = t.risk || '';
  document.getElementById('pnl').value = t.pnl || '';
  document.getElementById('equityBefore').value = t.equityBefore || '';
  document.getElementById('equityAfter').value = t.equityAfter || '';
  document.getElementById('entryDateTime').value = t.entryDateTime || '';
  document.getElementById('exitDateTime').value = t.exitDateTime || '';
  document.getElementById('marketDirection').value = t.marketDirection || '';
  document.getElementById('marketCondition').value = t.marketCondition || '';
  document.getElementById('executionTF').value = t.executionTF || '';
  // checkboxes
  const setChecks = (groupId, valuesStr) => {
    const vals = (valuesStr||'').split(',').map(s=>s.trim()).filter(Boolean);
    document.querySelectorAll(`#${groupId} input`).forEach(input=>{
      input.checked = vals.includes(input.value);
    });
  };
  setChecks('tf-group', t.tf);
  setChecks('conf-group', t.conf);
  setChecks('ind-group', t.ind);
  setChecks('psy-group', t.psy);
  document.getElementById('setupUrl').value = t.setupUrl || '';
  document.getElementById('entryUrl').value = t.entryUrl || '';
  document.getElementById('exitUrl').value = t.exitUrl || '';
  document.getElementById('strategy').value = t.strategy || '';
  document.getElementById('notes').value = t.notes || '';

  openModal('formModal');
}

function exportCSV(){
    const headers = ["ID","EntryDateTime","ExitDateTime","Broker","Account","Market","Instrument","Direction","EntryPrice","ExitPrice","SL","Result","Lot","Risk","PnL","EquityBefore","EquityAfter","MarketDirection","MarketCondition","TradeType","ExecutionTF","Strategy","Timeframes","Confluence","Indicators","Psychology","SetupURL","EntryURL","ExitURL","Notes"];
    let csv = headers.join(",") + "\n";
    
    trades.forEach(t => {
        const row = [
            t.displayId,
            `"${t.entryDateTime||''}"`,
            `"${t.exitDateTime||''}"`,
            `"${t.broker||''}"`,
            `"${t.account||''}"`,
            `"${t.market||''}"`,
            `"${t.instrument||''}"`,
            `"${t.direction||''}"`,
            t.entryPrice||'',
            t.exitPrice||'',
            t.sl||'',
            t.result||'',
            t.lot||'',
            t.risk||'',
            t.pnl||'',
            t.equityBefore||'',
            t.equityAfter||'',
            `"${t.marketDirection||''}"`,
            `"${t.marketCondition||''}"`,
            `"${t.tradeType||''}"`,
            `"${t.executionTF||''}"`,
            `"${(t.strategy||'').replace(/"/g, '""')}"`,
            `"${t.tf||''}"`,
            `"${t.conf||''}"`,
            `"${t.ind||''}"`,
            `"${t.psy||''}"`,
            `"${t.setupUrl||''}"`,
            `"${t.entryUrl||''}"`,
            `"${t.exitUrl||''}"`,
            `"${(t.notes||'').replace(/"/g, '""')}"`
        ];
        csv += row.join(",") + "\n";
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.setAttribute('href', url);
    a.setAttribute('download', `journal_export_${new Date().toISOString().slice(0,10)}.csv`);
    a.click();
}

function parseCSV(text) {
    const rows = [];
    let current = '';
    let insideQuotes = false;
    
    for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const nextChar = text[i + 1];
        
        if (char === '"') {
            if (insideQuotes && nextChar === '"') {
                current += '"';
                i++;
            } else {
                insideQuotes = !insideQuotes;
            }
        } else if (char === ',' && !insideQuotes) {
            rows.push(current.trim());
            current = '';
        } else if ((char === '\n' || char === '\r') && !insideQuotes) {
            if (current.trim()) rows.push(current.trim());
            current = '';
        } else {
            current += char;
        }
    }
    
    if (current.trim()) rows.push(current.trim());
    return rows;
}

function importCSV(event){
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e){
        try {
            const text = e.target.result;
            const lines = text.split('\n').filter(line => line.trim());
            
            if (lines.length < 2) {
                alert("CSV file is empty or has no data rows");
                return;
            }
            
            const headers = parseCSV(lines[0]);
            const expectedHeaders = ["ID","EntryDateTime","ExitDateTime","Broker","Account","Market","Instrument","Direction","EntryPrice","ExitPrice","SL","Result","Lot","Risk","PnL","EquityBefore","EquityAfter","MarketDirection","MarketCondition","TradeType","ExecutionTF","Strategy","Timeframes","Confluence","Indicators","Psychology","SetupURL","EntryURL","ExitURL","Notes"];
            
            // Validate headers
            if (headers.length < 20) {
                alert("CSV format is invalid. Please export and re-import using the Export feature.");
                return;
            }
            
            let importedCount = 0;
            let skippedCount = 0;
            
            for (let i = 1; i < lines.length; i++) {
                try {
                    const rowData = parseCSV(lines[i]);
                    
                    if (rowData.length === 0 || rowData.every(cell => !cell)) continue;
                    
                    // Check if this trade already exists (by ID or entry datetime)
                    const existingId = rowData[0];
                    const existingDateTime = rowData[1];
                    
                    const isDuplicate = trades.some(t => 
                        t.entryDateTime === existingDateTime || 
                        (t.displayId == parseInt(existingId))
                    );
                    
                    if (isDuplicate) {
                        skippedCount++;
                        continue;
                    }
                    
                    const record = {
                        id: Date.now().toString() + Math.random(),
                        displayId: parseInt(rowData[0]) || trades.length + 1,
                        entryDateTime: rowData[1] || '',
                        exitDateTime: rowData[2] || '',
                        broker: rowData[3] || '',
                        account: rowData[4] || '',
                        market: rowData[5] || '',
                        instrument: rowData[6] || '',
                        direction: rowData[7] || '',
                        entryPrice: rowData[8] || '',
                        exitPrice: rowData[9] || '',
                        sl: rowData[10] || '',
                        result: rowData[11] || '',
                        lot: rowData[12] || '',
                        risk: rowData[13] || '',
                        pnl: rowData[14] || '',
                        equityBefore: rowData[15] || '',
                        equityAfter: rowData[16] || '',
                        marketDirection: rowData[17] || '',
                        marketCondition: rowData[18] || '',
                        tradeType: rowData[19] || '',
                        executionTF: rowData[20] || '',
                        strategy: rowData[21] || '',
                        tf: rowData[22] || '',
                        conf: rowData[23] || '',
                        ind: rowData[24] || '',
                        psy: rowData[25] || '',
                        setupUrl: rowData[26] || '',
                        entryUrl: rowData[27] || '',
                        exitUrl: rowData[28] || '',
                        notes: rowData[29] || ''
                    };
                    
                    // Validate required fields
                    if (!record.entryDateTime) {
                        skippedCount++;
                        continue;
                    }
                    
                    trades.push(record);
                    importedCount++;
                    
                } catch (rowErr) {
                    skippedCount++;
                    console.error("Error parsing row " + i, rowErr);
                }
            }
            
            // Recompute displayId
            trades.forEach((tr, i) => tr.displayId = i + 1);
            
            localStorage.setItem("journalTrades", JSON.stringify(trades));
            
            if (importedCount > 0) {
                alert(`âœ“ Import successful!\n${importedCount} trades imported.\n${skippedCount} rows skipped (duplicates or invalid).`);
                render();
                document.getElementById('csvImport').value = '';
            } else {
                alert(`No valid trades to import.\n${skippedCount} rows skipped.`);
            }
            
        } catch (err) {
            console.error("Import error:", err);
            alert("Error importing CSV: " + err.message);
        }
    };
    reader.readAsText(file);
}

render();
</script>

</body>
</html>